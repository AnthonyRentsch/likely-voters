---
title: "Cutoff Models"
date: "2017-11-05"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    collapsed: false
    smooth_scroll: false
    df_print: kable
---

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::read_chunk('load.R')
```

```{r, echo = FALSE, include = FALSE}
# run load.R 
<<load>> 
```

# Introduction

In this document, I will define and create the cutoff models that I will use for my analysis and then evaluate their performance. The sections will proceed as follows:

* Vote intent
* Vote intent + vote history
* Perry-Gallup index
* Logistic regression
    + Perry-Gallup
    + Perry-Gallup + all variables potentially related to turnout 
   + Perry-Gallup + all variables potentially related to turnout + structural election variables
* Random forests
    + Perry-Gallup
    + Perry-Gallup + all variables potentially related to turnout 
    + Perry-Gallup + all variables potentially related to turnout + structural election variables
  
In each section I will create a model and then evaluate how well it predicts voting behavior on an individual-level using a simulation-based approach. At the end, I will use these models to make election predictions.



# Vote Intent

For now, I am doing this for 2016 until I can create the pooled data set. Here I treat people who report that they have already voted the same as people who report that they definitely plan to vote. Note that the weight I use -- `commonweight` from the `cces16` data -- combines weights based on age, gender, education, race, voter registration, ideology, baseline party identification, born again status, and political interest.


```{r}
# grab data and filter only those with valid vote intent responses
data <- cces16 %>% select(V101, state_abbreviation, CC16_364, CC16_364b, CC16_364c,  
                          CL_E2016GVM, commonweight) %>% 
  rename(ID = V101, state = state_abbreviation, intent = CC16_364, earlychoice = CC16_364b, 
         choice = CC16_364c, validated = CL_E2016GVM, weight = commonweight) %>% 
  filter(intent %in% c(1,2,3,4,5))

# merge vote choice for early/absentee voters and prospective voters
data <- data %>% 
  mutate(choice = replace(choice, earlychoice == 1, 1)) %>% 
  mutate(choice = replace(choice, earlychoice == 2, 2))
```



## Individual-level turnout

```{r}
validation_by_intent <- function(intention){
  willvote <- data %>% 
    filter(intent %in% intention)
  wontvote <- data %>% 
    anti_join(willvote, by = "ID")

  pred_voters <- willvote %>% 
    count(validated = !is.na(validated)) %>% 
    mutate(percent = round((n/sum(n))*100,2)) %>% 
    mutate(validated = replace(validated, validated == "FALSE", "No")) %>% 
    mutate(validated = replace(validated, validated == "TRUE", "Yes")) %>% 
    select(-n)
  
  pred_nonvoters <- wontvote %>% 
    count(validated = !is.na(validated)) %>% 
    mutate(percent = round((n/sum(n))*100,2)) %>% 
    mutate(validated = replace(validated, validated == "FALSE", "No")) %>% 
    mutate(validated = replace(validated, validated == "TRUE", "Yes")) %>% 
    select(-n)
  
  left_join(pred_voters, pred_nonvoters, by = "validated", suffix = c("_v","_nv")) %>% 
    rename(voters = percent_v, nonvoters = percent_nv)
}
```

First we compare individual-level turnout prediction accuracy when we define likely voters as:

* those who say they already voted
* those who say they will definitely vote or have voted already
* those who say they will definitely vote, have voted already, or will probably vote
* those who say they will definitely vote, have voted already, will probably vote, or who are undecided
* all respondents in the sample

Let's sum that all up, where

* true positive rate = rate at which predicted voters are validated as voters
* false positive rate = rate at which predicted voters are not validated as voters
* false negative rate = rate at which predicted nonvoters are validated as voters
* true negative rate = rate at which predicted nonvoters are not validated as voters

```{r, echo = FALSE, warning = FALSE}
# those who say they already voted
mod1 <- validation_by_intent(3)
# those who say they will definitely vote or have voted already
mod2 <- validation_by_intent(c(1,3))
# those who say they will definitely vote, have voted already, or will probably vote
mod3 <- validation_by_intent(c(1,2,3))
# those who say they will definitely vote, have voted already, will probably vote, or who are undecided
mod4 <- validation_by_intent(c(1,2,3,5))
# all respondents in the sample
mod5 <- validation_by_intent(c(1,2,3,4,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 true_positive = vector(length = 5),
                 false_positive = vector(length = 5),
                 false_negative = vector(length = 5),
                 true_negative = vector(length = 5))
i <- 1
while(i <= length(mods)){
  df$true_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "Yes"]
  df$false_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "No"]
  df$false_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "Yes"]
  df$true_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "No"]
  i = i +1
}
                 
df$model <- factor(df$model, levels = df$model)

df %>% gather(type, value, true_positive:true_negative) %>%
  ggplot(aes(factor(model), value, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "model", y = "rate") +
  scale_fill_grey()
```


## Election predictions


```{r}
vote_choice_intent <- function(intention){
  data %>% 
  filter(intent %in% intention) %>% 
  filter(choice %in% c(1,2) | earlychoice %in% c(1,2)) %>% 
  mutate(choice = replace(choice, choice == 1, "Trump")) %>% 
  mutate(choice = replace(choice, choice == 2, "Clinton")) %>% 
  group_by(choice) %>% 
  summarise(n = sum(weight)) %>% 
  mutate(vote_share = round(n/sum(n)*100,2)) %>% 
  select(-n)
}
```

Now we compare election predictions, using the same likely voter models as specified above.

```{r, echo = FALSE}
mod1 <- vote_choice_intent(3)
mod2 <- vote_choice_intent(c(1,3))
mod3 <- vote_choice_intent(c(1,2,3))
mod4 <- vote_choice_intent(c(1,2,3,5))
mod5 <- vote_choice_intent(c(1,2,3,4,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents", "Actual result"),
                 margin = vector(length = 6))

i <- 1
while(i <= length(mods)){
  df$margin[i] = mods[[i]]$vote_share[mods[[i]]$choice == "Clinton"] - mods[[i]]$vote_share[mods[[i]]$choice == "Trump"]
  i = i + 1
}

df$margin[6] <- 2.1

df$model <- factor(df$model, levels = df$model)

df %>%  
  ggplot() +
  geom_col(aes(model, margin)) +
  coord_flip() +
  labs(y = "Clinton's predicted margin of victory")
```



# Vote Intent + Vote History

Let's move on to the next baseline model - using vote history and vote intent. I follow the same template from above but consider what happens when likely voters are defined as individuals who report that they voted in the previous presidential election (2012) as well as what happens when we do not make that distinction.

```{r, echo = FALSE}
# grab data and filter only those with valid vote intent and vote history responses
data <- cces16 %>% select(V101, state_abbreviation, CC16_364, CC16_364b, CC16_364c, CC16_326,  
                          CL_E2016GVM, commonweight) %>% 
  rename(ID = V101, state = state_abbreviation, intent = CC16_364, earlychoice = CC16_364b, 
         choice = CC16_364c, vote12 = CC16_326, validated = CL_E2016GVM, weight = commonweight) %>% 
  filter(intent %in% c(1,2,3,4,5)) %>% 
  filter(vote12 %in% c(1,2,3,4,5))

# merge vote choice for early/absentee voters and prospective voters
data <- data %>% 
  mutate(choice = replace(choice, earlychoice == 1, 1)) %>% 
  mutate(choice = replace(choice, earlychoice == 2, 2))
```

## Individual-level turnout

```{r, echo = FALSE}
validation_intent_history <- function(intention, history){
  willvote <- data %>% 
    filter(intent %in% intention, vote12 %in% history)
  wontvote <- data %>% 
    anti_join(willvote, by = "ID")

  pred_voters <- willvote %>% 
    count(validated = !is.na(validated)) %>% 
    mutate(percent = round((n/sum(n))*100,2)) %>% 
    mutate(validated = replace(validated, validated == "FALSE", "No")) %>% 
    mutate(validated = replace(validated, validated == "TRUE", "Yes")) %>% 
    select(-n)
  
  pred_nonvoters <- wontvote %>% 
    count(validated = !is.na(validated)) %>% 
    mutate(percent = round((n/sum(n))*100,2)) %>% 
    mutate(validated = replace(validated, validated == "FALSE", "No")) %>% 
    mutate(validated = replace(validated, validated == "TRUE", "Yes")) %>% 
    select(-n)
  
  left_join(pred_voters, pred_nonvoters, by = "validated", suffix = c("_v","_nv")) %>% 
    rename(voters = percent_v, nonvoters = percent_nv)
}
```

First, I'll consider everyone who self-reported that they voted in 2012. Note that this will necessarily exclude any respondent who was too young to vote in 2012 (unless they lie on this question, of course).

```{r, echo = FALSE, warning = FALSE}
mod1 <- validation_intent_history(3, c(1,2,3))
mod2 <- validation_intent_history(c(1,3), c(1,2,3))
mod3 <- validation_intent_history(c(1,2,3), c(1,2,3))
mod4 <- validation_intent_history(c(1,2,3,5), c(1,2,3))
mod5 <- validation_intent_history(c(1,2,3,4,5), c(1,2,3))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 true_positive = vector(length = 5),
                 false_positive = vector(length = 5),
                 false_negative = vector(length = 5),
                 true_negative = vector(length = 5))
i <- 1
while(i <= length(mods)){
  df$true_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "Yes"]
  df$false_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "No"]
  df$false_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "Yes"]
  df$true_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "No"]
  i = i +1
}
                 
df$model <- factor(df$model, levels = df$model)

df %>% gather(type, value, true_positive:true_negative) %>%
  ggplot(aes(factor(model), value, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "model", y = "rate", title = "Voted in 2012") +
  scale_fill_grey()
```

```{r, echo = FALSE, warning = FALSE}
mod1 <- validation_intent_history(3, c(1,2,3,5))
mod2 <- validation_intent_history(c(1,3), c(1,2,3,5))
mod3 <- validation_intent_history(c(1,2,3), c(1,2,3,5))
mod4 <- validation_intent_history(c(1,2,3,5), c(1,2,3,5))
mod5 <- validation_intent_history(c(1,2,3,4,5), c(1,2,3,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 true_positive = vector(length = 5),
                 false_positive = vector(length = 5),
                 false_negative = vector(length = 5),
                 true_negative = vector(length = 5))
i <- 1
while(i <= length(mods)){
  df$true_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "Yes"]
  df$false_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "No"]
  df$false_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "Yes"]
  df$true_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "No"]
  i = i +1
}
                 
df$model <- factor(df$model, levels = df$model)

df %>% gather(type, value, true_positive:true_negative) %>%
  ggplot(aes(factor(model), value, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "model", y = "rate", title = "Voted in 2012 or don't recall") +
  scale_fill_grey()
```

```{r, echo = FALSE, warning = FALSE}
mod1 <- validation_intent_history(3, c(1,2,3,4,5))
mod2 <- validation_intent_history(c(1,3), c(1,2,3,4,5))
mod3 <- validation_intent_history(c(1,2,3), c(1,2,3,4,5))
mod4 <- validation_intent_history(c(1,2,3,5), c(1,2,3,4,5))
mod5 <- validation_intent_history(c(1,2,3,4,5), c(1,2,3,4,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 true_positive = vector(length = 5),
                 false_positive = vector(length = 5),
                 false_negative = vector(length = 5),
                 true_negative = vector(length = 5))
i <- 1
while(i <= length(mods)){
  df$true_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "Yes"]
  df$false_positive[i] <- mods[[i]]$voters[mods[[i]]$validated == "No"]
  df$false_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "Yes"]
  df$true_negative[i] <- mods[[i]]$nonvoters[mods[[i]]$validated == "No"]
  i = i +1
}
                 
df$model <- factor(df$model, levels = df$model)

df %>% gather(type, value, true_positive:true_negative) %>%
  ggplot(aes(factor(model), value, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "model", y = "rate", title = "Voted in 2012, don't recall, or didn't vote") +
  scale_fill_grey()
```

Might be useful to make a table with this, as this is a lot to take in visually.

## Election predictions

```{r, echo = FALSE, warning = FALSE}
vote_choice_intent <- function(intention, history){
  data %>% 
  filter(intent %in% intention, vote12 %in% history) %>% 
  filter(choice %in% c(1,2) | earlychoice %in% c(1,2)) %>% 
  mutate(choice = replace(choice, choice == 1, "Trump")) %>% 
  mutate(choice = replace(choice, choice == 2, "Clinton")) %>% 
  group_by(choice) %>% 
  summarise(n = sum(weight)) %>% 
  mutate(vote_share = round(n/sum(n)*100,2)) %>% 
  select(-n)
}
```

```{r, echo = FALSE}
# voted in 2012
mod1 <- vote_choice_intent(3, c(1,2,3))
mod2 <- vote_choice_intent(c(1,3), c(1,2,3))
mod3 <- vote_choice_intent(c(1,2,3), c(1,2,3))
mod4 <- vote_choice_intent(c(1,2,3,5), c(1,2,3))
mod5 <- vote_choice_intent(c(1,2,3,4,5), c(1,2,3))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df1 <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 margin = vector(length = 5))

i <- 1
while(i <= length(mods)){
  df1$margin[i] = mods[[i]]$vote_share[mods[[i]]$choice == "Clinton"] - mods[[i]]$vote_share[mods[[i]]$choice=="Trump"]
  i = i + 1
}

df1$model <- factor(df1$model, levels = df1$model)

# voted in 2012 or don't recall
mod1 <- vote_choice_intent(3, c(1,2,3,5))
mod2 <- vote_choice_intent(c(1,3), c(1,2,3,5))
mod3 <- vote_choice_intent(c(1,2,3), c(1,2,3,5))
mod4 <- vote_choice_intent(c(1,2,3,5), c(1,2,3,5))
mod5 <- vote_choice_intent(c(1,2,3,4,5), c(1,2,3,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df2 <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 margin = vector(length = 5))

i <- 1
while(i <= length(mods)){
  df2$margin[i] = mods[[i]]$vote_share[mods[[i]]$choice == "Clinton"] - mods[[i]]$vote_share[mods[[i]]$choice == "Trump"]
  i = i + 1
}

df2$model <- factor(df2$model, levels = df2$model)

# voted in 2012, don't recall, or did not vote
mod1 <- vote_choice_intent(3, c(1,2,3,4,5))
mod2 <- vote_choice_intent(c(1,3), c(1,2,3,4,5))
mod3 <- vote_choice_intent(c(1,2,3), c(1,2,3,4,5))
mod4 <- vote_choice_intent(c(1,2,3,5), c(1,2,3,4,5))
mod5 <- vote_choice_intent(c(1,2,3,4,5), c(1,2,3,4,5))

mods <- list(mod1, mod2, mod3, mod4, mod5)

df3 <- data.frame(model = c("Already voted", "Already voted + will definitely vote", "Already voted + will definitely or probably vote", "Already voted + will definitely or probably vote + undecided", "All respondents"),
                 margin = vector(length = 5))

i <- 1
while(i <= length(mods)){
  df3$margin[i] = mods[[i]]$vote_share[mods[[i]]$choice == "Clinton"] - mods[[i]]$vote_share[mods[[i]]$choice == "Trump"]
  i = i + 1
}

df3$model <- factor(df3$model, levels = df3$model)
```

```{r, echo = FALSE, warning = FALSE}
df_combined <- join_all(list(df1, df2, df3), by = "model")
names(df_combined) <- c("model", "Voted in 2012", "Voted in 2012 or didn't recall", "All")

df_combined %>% gather(`Vote history`, value, `Voted in 2012`:All) %>%  
  ggplot(aes(factor(model), value, fill = `Vote history`)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  labs(x = "Vote intent", y = "Clinton's predicted margin of victory") +
  scale_fill_grey() +
  geom_hline(yintercept = 2.1, lty = 2, colour = "red")
```

My takeaway is that adding vote history does not add much information on top of vote intent. But this is just for 2016 election predictions - may be useful to predict individual-level turnout and may be useful for other elections still.


# Perry-Gallup index
